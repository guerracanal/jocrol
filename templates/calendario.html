{% extends "base.html" %}

{% block title %}Calendario - Gestión de Lanzamientos{% endblock %}

{% block styles %}
<style>
    /* Mejora el cursor y añade una transición suave al pasar sobre los eventos */
    .fc-event {
        cursor: pointer;
        transition: opacity 0.2s ease-in-out;
    }

    /* Efecto de hover para los eventos del calendario */
    .fc-event:hover {
        opacity: 0.85;
    }

    /* Nos aseguramos de que el punto en la vista de lista no tenga un borde que interfiera con el color */
    .fc-list-event-dot {
        border-color: transparent !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Calendario</h1>
</div>

<div id="calendar" class="card card-body"></div>

<!-- Modal para detalles -->
<div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalLabel">Detalles del Evento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4 id="eventTitle" class="mb-1"></h4>
                <p id="eventDate" class="text-muted"></p>
                <ul id="eventProps" class="list-group list-group-flush mt-3"></ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="bi bi-x-lg me-1"></i>Cerrar</button>
                <a href="#" class="btn btn-outline-primary" id="googleCalendarBtn" target="_blank"><img src="https://calendar.google.com/googlecalendar/images/favicons_2020q4/calendar_31.ico" width="16" height="16" class="me-2">Añadir a Google Calendar</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

    const formatDate = (date) => {
        if (!date) return 'Fecha no disponible';
        return new Date(date).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
    };

    const getTextColorForBg = (hexColor) => {
        if (!hexColor) return '#000000';
        const hex = hexColor.replace('#', '');
        const r = parseInt(hex.substring(0, 2), 16);
        const g = parseInt(hex.substring(2, 4), 16);
        const b = parseInt(hex.substring(4, 6), 16);
        const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
        return luminance > 0.5 ? '#000000' : '#ffffff';
    };

    const handleEventClick = (info) => {
        const { title, start, extendedProps } = info.event;
        
        document.getElementById('eventTitle').innerHTML = title; // Usamos innerHTML para renderizar el badge
        document.getElementById('eventDate').textContent = formatDate(start);
        
        const propsList = document.getElementById('eventProps');
        propsList.innerHTML = '';

        const createListItem = (icon, label, value) => {
            if (value === null || value === undefined || value === '') return '';
            return `<li class="list-group-item d-flex align-items-center"><i class="bi ${icon} me-3"></i><strong>${label}:</strong><span class="ms-2">${value}</span></li>`;
        };

        let propsHtml = '';
        if (extendedProps) {
            const { tipo, juego, coleccion, juego_color, coleccion_color, precio, reserva, comentario, fecha_envio, fecha_salida, fecha } = extendedProps;
            
            if(tipo) propsHtml += createListItem('bi-tag-fill', 'Tipo', tipo);
            if(juego) propsHtml += createListItem('bi-joystick', 'Juego', `<span class="badge" style="background-color: ${juego_color}; color: ${getTextColorForBg(juego_color)}">${juego}</span>`);
            if(coleccion) propsHtml += createListItem('bi-collection-fill', 'Colección', `<span class="badge" style="background-color: ${coleccion_color}; color: ${getTextColorForBg(coleccion_color)}">${coleccion}</span>`);
            if(fecha) propsHtml += createListItem('bi-calendar-check', 'Fecha', formatDate(fecha));
            if(fecha_envio) propsHtml += createListItem('bi-calendar-check', 'Fecha Salida', formatDate(fecha_salida));
            if(fecha_salida) propsHtml += createListItem('bi-calendar-check-fill', 'Fecha Envío', formatDate(fecha_envio));
            if (precio) propsHtml += createListItem('bi-currency-euro', 'Precio', `${precio}€`);
            if (reserva) propsHtml += createListItem('bi-coin', 'Reserva', `${reserva}€`);
            if (comentario) propsHtml += createListItem('bi-chat-left-text', 'Comentario', comentario);
        }
        propsList.innerHTML = propsHtml;

        // Configurar botón de Google Calendar
        const googleCalendarBtn = document.getElementById('googleCalendarBtn');
        const googleCalendarUrl = createGoogleCalendarUrl(info.event);
        if (googleCalendarUrl) {
            googleCalendarBtn.href = googleCalendarUrl;
            googleCalendarBtn.style.display = '';
        } else {
            googleCalendarBtn.style.display = 'none';
        }

        eventModal.show();
    };

    const createGoogleCalendarUrl = (event) => {
        if (!event.start) return null;

        const title = encodeURIComponent(event.extendedProps.nombre || event.title);
        const details = encodeURIComponent(
            Object.entries(event.extendedProps)
                .map(([key, value]) => `${key}: ${value}`)
                .join('\n')
        );

        const toGoogleDate = (date) => date.toISOString().replace(/-|:|\.\d{3}/g, '');

        const startDate = new Date(event.start);
        let endDate;

        if (event.allDay) {
            endDate = new Date(startDate.getTime());
            endDate.setDate(startDate.getDate() + 1);
            return `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${toGoogleDate(endDate).substring(0,8)}/${toGoogleDate(endDate).substring(0,8)}&details=${details}`;
        } else {
            endDate = event.end ? new Date(event.end) : new Date(startDate.getTime() + 60 * 60 * 1000);
            return `https://www.google.com/calendar/render?action=TEMPLATE&text=${title}&dates=${toGoogleDate(endDate)}/${toGoogleDate(endDate)}&details=${details}`;
        }
    };

    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: 'auto',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: '/api/eventos',
        eventClick: handleEventClick,
        eventDidMount: function(info) {
            const { coleccion_color, juego_color } = info.event.extendedProps;
            const titleEl = info.el.querySelector('.fc-event-title');
            if (titleEl) {
                titleEl.innerHTML = info.event.title;
            }
        },
        eventContent: function(arg) {
            return { html: arg.event.title };
        }
    });

    calendar.render();
});
</script>
{% endblock %}