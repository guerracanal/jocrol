{% extends "base.html" %}
{% block content %}
<h1>Nueva Reserva</h1>
<form method="POST">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label for="cliente_id" class="form-label">Cliente</label>
                <select class="form-control" id="cliente_id" name="cliente_id" required>
                    <option value="">Seleccionar cliente...</option>
                    {% for cliente in clientes %}
                    <option value="{{ cliente.id }}">{{ cliente.nombre }} ({{ cliente.email }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label for="tipo_reserva" class="form-label">Tipo de Reserva</label>
                <select class="form-control" id="tipo_reserva" name="tipo_reserva">
                    <option value="lanzamiento" selected>Lanzamiento</option>
                    <option value="evento">Evento</option>
                </select>
            </div>
            
            <div class="mb-3" id="lanzamiento-group">
                <label for="lanzamiento_id" class="form-label">Lanzamiento</label>
                <select class="form-control" id="lanzamiento_id" name="lanzamiento_id">
                    <option value="" data-precio="0" data-reserva="0">Seleccionar lanzamiento...</option>
                    {% for lanzamiento in lanzamientos %}
                    <option value="{{ lanzamiento.id }}" 
                            data-precio="{{ lanzamiento.precio or 0 }}" 
                            data-reserva="{{ lanzamiento.reserva or 0 }}">
                        {{ lanzamiento.nombre }} - {{ lanzamiento.coleccion }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3 d-none" id="evento-group">
                <label for="evento_id" class="form-label">Evento</label>
                <select class="form-control" id="evento_id" name="evento_id">
                    <option value="" data-precio="0" data-reserva="0">Seleccionar evento...</option>
                    {% for evento in eventos %}
                    <option value="{{ evento.id }}" 
                            data-precio="{{ evento.precio or 0 }}" 
                            data-reserva="{{ evento.reserva or 0 }}">
                        {{ evento.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="mb-3">
                <label for="cantidad" class="form-label">Cantidad</label>
                <input type="number" min="1" class="form-control" id="cantidad" name="cantidad" value="1" required>
            </div>

            <div class="mb-3">
                <label for="fecha_reserva" class="form-label">Fecha de Reserva</label>
                <input type="date" class="form-control" id="fecha_reserva" name="fecha_reserva" 
                       value="{{ now.strftime('%Y-%m-%d') }}">
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="mb-3">
                <label for="estado" class="form-label">Estado</label>
                <select class="form-control" id="estado" name="estado">
                    <option value="pendiente" selected>Pendiente</option>
                    <option value="confirmada">Confirmada</option>
                    <option value="cancelada">Cancelada</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="pagado_cantidad" class="form-label">Cantidad Pagada (€)</label>
                <input type="number" step="0.01" class="form-control" id="pagado_cantidad" name="pagado_cantidad" value="0.00">
            </div>

            <div class="mb-3">
                <label for="tipo_pago" class="form-label">Tipo de Pago</label>
                <select class="form-control" id="tipo_pago" name="tipo_pago">
                    <option value="Visa">Visa</option>
                    <option value="Efectivo">Efectivo</option>
                    <option value="Paygold">Paygold</option>
                </select>
            </div>

            <div class="mb-3">
                <label for="notas" class="form-label">Notas</label>
                <textarea class="form-control" id="notas" name="notas" rows="3"></textarea>
            </div>

            <div class="mb-3 p-3 border rounded bg-light">
                <h5>Resumen de Pago</h5>
                <p>Precio Unitario: <strong id="precio-unitario">0.00 €</strong></p>
                <p>Importe Total: <strong id="total-reserva">0.00 €</strong></p>
                <p>Importe Pendiente: <strong id="pendiente-reserva" class="text-danger">0.00 €</strong></p>
                <p><small class="text-muted">Importe de la reserva: <strong id="importe-reserva">0.00 €</strong></small></p>
            </div>
            
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="pagado" name="pagado">
                <label class="form-check-label" for="pagado">Reserva Completamente Pagada</label>
            </div>
        </div>
    </div>
    
    <button type="submit" class="btn btn-success">Crear Reserva</button>
    <a href="{{ url_for('reservas.listar_reservas') }}" class="btn btn-secondary">Cancelar</a>
</form>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const tipoReservaSelect = document.getElementById('tipo_reserva');
    const lanzamientoGroup = document.getElementById('lanzamiento-group');
    const eventoGroup = document.getElementById('evento-group');
    const lanzamientoSelect = document.getElementById('lanzamiento_id');
    const eventoSelect = document.getElementById('evento_id');
    const cantidadInput = document.getElementById('cantidad');
    const pagadoInput = document.getElementById('pagado_cantidad');

    const precioUnitarioElem = document.getElementById('precio-unitario');
    const totalReservaElem = document.getElementById('total-reserva');
    const pendienteReservaElem = document.getElementById('pendiente-reserva');
    const importeReservaElem = document.getElementById('importe-reserva');

    function toggleReservaFields() {
        if (tipoReservaSelect.value === 'lanzamiento') {
            lanzamientoGroup.classList.remove('d-none');
            eventoGroup.classList.add('d-none');
            eventoSelect.value = '';
        } else {
            lanzamientoGroup.classList.add('d-none');
            eventoGroup.classList.remove('d-none');
            lanzamientoSelect.value = '';
        }
        autoFillPagado();
    }

    function calcularTotales() {
        let selectedOption;
        let importeReserva = 0;
        if (tipoReservaSelect.value === 'lanzamiento') {
            selectedOption = lanzamientoSelect.options[lanzamientoSelect.selectedIndex];
            if(selectedOption) {
              importeReserva = parseFloat(selectedOption.dataset.reserva) || 0;
            }
        } else {
            selectedOption = eventoSelect.options[eventoSelect.selectedIndex];
            if(selectedOption) {
              importeReserva = parseFloat(selectedOption.dataset.reserva) || 0;
            }
        }

        const precioUnitario = selectedOption ? parseFloat(selectedOption.dataset.precio) || 0 : 0;
        const cantidad = parseInt(cantidadInput.value) || 1;
        const pagado = parseFloat(pagadoInput.value) || 0;

        const totalReserva = precioUnitario * cantidad;
        const pendiente = totalReserva - pagado;
        const totalReservaConImporte = importeReserva * cantidad;

        precioUnitarioElem.textContent = precioUnitario.toFixed(2) + ' €';
        totalReservaElem.textContent = totalReserva.toFixed(2) + ' €';
        pendienteReservaElem.textContent = pendiente.toFixed(2) + ' €';
        importeReservaElem.textContent = totalReservaConImporte.toFixed(2) + ' €';
        
        if (pendiente <= 0) {
            pendienteReservaElem.classList.remove('text-danger');
            pendienteReservaElem.classList.add('text-success');
        } else {
            pendienteReservaElem.classList.add('text-danger');
            pendienteReservaElem.classList.remove('text-success');
        }
    }

    function autoFillPagado() {
        let selectedOption;
        let importeReserva = 0;
        if (tipoReservaSelect.value === 'lanzamiento') {
            selectedOption = lanzamientoSelect.options[lanzamientoSelect.selectedIndex];
            if(selectedOption) {
              importeReserva = parseFloat(selectedOption.dataset.reserva) || 0;
            }
        } else {
            selectedOption = eventoSelect.options[eventoSelect.selectedIndex];
            if(selectedOption) {
              importeReserva = parseFloat(selectedOption.dataset.reserva) || 0;
            }
        }
        const cantidad = parseInt(cantidadInput.value) || 1;

        if (importeReserva > 0) {
            pagadoInput.value = (importeReserva * cantidad).toFixed(2);
        }
        calcularTotales();
    }

    tipoReservaSelect.addEventListener('change', toggleReservaFields);
    lanzamientoSelect.addEventListener('change', autoFillPagado);
    eventoSelect.addEventListener('change', autoFillPagado);
    cantidadInput.addEventListener('input', autoFillPagado);
    pagadoInput.addEventListener('input', calcularTotales);

    // Initial setup
    toggleReservaFields();
});
</script>
{% endblock %}
