{% extends 'base.html' %}

{% block title %}Editar Reserva - Gestión de Lanzamientos{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Editar Reserva</h2>
    <form action="{{ url_for('reservas.editar_reserva', reserva_id=reserva.id) }}" method="post">

        <div class="mb-3">
            <label for="cliente_id" class="form-label">Cliente</label>
            <select class="form-select" id="cliente_id" name="cliente_id" required>
                <option value="">Selecciona un cliente</option>
                {% for cliente in clientes %}
                <option value="{{ cliente.id }}" {% if cliente.id == reserva.cliente_id %}selected{% endif %}>{{ cliente.nombre }} ({{ cliente.telefono }})</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="tipo_producto" class="form-label">Tipo de Producto</label>
            <select class="form-select" id="tipo_producto" name="tipo_producto">
                <option value="lanzamiento" {% if reserva.lanzamiento_id %}selected{% endif %}>Lanzamiento</option>
                <option value="evento" {% if reserva.evento_id %}selected{% endif %}>Evento</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="juego" class="form-label">Juego</label>
            <select class="form-select" id="juego" name="juego" required>
                <option value="">Selecciona un juego</option>
                {% for juego in juegos %}
                <option value="{{ juego }}" {% if producto and juego == producto.juego %}selected{% endif %}>{{ juego }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="mb-3">
            <label for="coleccion" class="form-label">Colección</label>
            <select class="form-select" id="coleccion" name="coleccion" disabled>
                <option value="">Primero selecciona un juego</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="producto_id" class="form-label">Producto</label>
            <select class="form-select" id="producto_id" name="producto_id" required disabled>
                <option value="">Selecciona un producto</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="cantidad" class="form-label">Cantidad</label>
            <input type="number" class="form-control" id="cantidad" name="cantidad" value="{{ reserva.cantidad }}" min="1" required>
        </div>

        <div class="mb-3">
            <label for="pagado" class="form-label">Pagado</label>
            <input type="number" step="0.01" class="form-control" id="pagado" name="pagado" value="{{ reserva.pagado or 0 }}">
        </div>

        <div class="mb-3">
            <label for="estado" class="form-label">Estado</label>
            <select class="form-select" id="estado" name="estado">
                <option value="Pendiente" {% if reserva.estado == 'Pendiente' %}selected{% endif %}>Pendiente</option>
                <option value="Confirmado" {% if reserva.estado == 'Confirmado' %}selected{% endif %}>Confirmado</option>
                <option value="Cancelado" {% if reserva.estado == 'Cancelado' %}selected{% endif %}>Cancelado</option>
                <option value="Entregado" {% if reserva.estado == 'Entregado' %}selected{% endif %}>Entregado</option>
            </select>
        </div>

        <div class="mb-3 p-3 border rounded bg-light">
            <h5>Resumen de Pago</h5>
            <p>Precio Unitario: <strong id="precio-unitario">0.00 €</strong></p>
            <p>Precio Reserva: <strong id="precio-reserva">0.00 €</strong></p>
            <p>Importe Total: <strong id="total-reserva">0.00 €</strong></p>
            <p>Importe Pendiente: <strong id="pendiente-reserva" class="text-danger">0.00 €</strong></p>
        </div>

        <div class="mb-3">
            <label for="tipo_pago" class="form-label">Tipo de Pago</label>
            <select class="form-select" id="tipo_pago" name="tipo_pago">
                <option value="">Selecciona un método de pago</option>
                <option value="Visa" {% if reserva.tipo_pago == 'Visa' %}selected{% endif %}>Visa</option>
                <option value="Efectivo" {% if reserva.tipo_pago == 'Efectivo' %}selected{% endif %}>Efectivo</option>
                <option value="paygold" {% if reserva.tipo_pago == 'paygold' %}selected{% endif %}>PayGold</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="notas" class="form-label">Notas</label>
            <textarea class="form-control" id="notas" name="notas" rows="3">{{ reserva.notas or '' }}</textarea>
        </div>

        <button type="submit" class="btn btn-primary">Guardar Cambios</button>
        <a href="{{ url_for('reservas.listar_reservas') }}" class="btn btn-secondary">Cancelar</a>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tipoProductoSelect = document.getElementById('tipo_producto');
        const juegoSelect = document.getElementById('juego');
        const coleccionSelect = document.getElementById('coleccion');
        const productoSelect = document.getElementById('producto_id');
        const cantidadInput = document.getElementById('cantidad');
        const pagadoInput = document.getElementById('pagado');
        const precioUnitarioElem = document.getElementById('precio-unitario');
        const precioReservaElem = document.getElementById('precio-reserva');
        const totalReservaElem = document.getElementById('total-reserva');
        const pendienteReservaElem = document.getElementById('pendiente-reserva');

        const juegosData = {{ juegos_colecciones|tojson }};
        const productos = {
            lanzamientos: {{ lanzamientos|tojson }},
            eventos: {{ eventos|tojson }}
        };
        
        const initialJuego = '{{ producto.juego if producto else '' }}';
        const initialColeccion = '{{ producto.coleccion if producto else '' }}';
        const initialProductoId = '{{ reserva.lanzamiento_id or reserva.evento_id }}';
        const initialPagado = parseFloat('{{ reserva.pagado or 0 }}');

        function calcularTotales() {
            const selectedOption = productoSelect.options[productoSelect.selectedIndex];
            let precioUnitario = 0;
            let precioReserva = 0;

            if (selectedOption && selectedOption.dataset.precio) {
                precioUnitario = parseFloat(selectedOption.dataset.precio) || 0;
                precioReserva = parseFloat(selectedOption.dataset.precioReserva) || 0;
            }

            const cantidad = parseInt(cantidadInput.value) || 1;
            const pagado = parseFloat(pagadoInput.value) || 0;
            const totalReserva = (precioUnitario * cantidad) + precioReserva;
            const pendiente = totalReserva - pagado;

            precioUnitarioElem.textContent = precioUnitario.toFixed(2) + ' €';
            precioReservaElem.textContent = precioReserva.toFixed(2) + ' €';
            totalReservaElem.textContent = totalReserva.toFixed(2) + ' €';
            pendienteReservaElem.textContent = pendiente.toFixed(2) + ' €';
            
            if (pendiente <= 0) {
                pendienteReservaElem.classList.remove('text-danger');
                pendienteReservaElem.classList.add('text-success');
            } else {
                pendienteReservaElem.classList.add('text-danger');
                pendienteReservaElem.classList.remove('text-success');
            }
        }

        function populateColecciones(selectedJuego, selectedColeccion) {
            coleccionSelect.innerHTML = '<option value="">Todas las colecciones</option>';
            coleccionSelect.disabled = true;

            if (selectedJuego && juegosData.juegos[selectedJuego]) {
                const colecciones = Object.values(juegosData.juegos[selectedJuego].colecciones).flat();
                coleccionSelect.disabled = false;
                colecciones.forEach(function(coleccion) {
                    const option = document.createElement('option');
                    option.value = coleccion;
                    option.textContent = coleccion;
                    if (coleccion === selectedColeccion) {
                        option.selected = true;
                    }
                    coleccionSelect.appendChild(option);
                });
            }
        }

        function updateProductos(selectedJuego, selectedColeccion, selectedProductoId) {
            const tipoProducto = tipoProductoSelect.value === 'lanzamiento' ? 'lanzamientos' : 'eventos';
            const productosDisponibles = productos[tipoProducto];

            productoSelect.innerHTML = '<option value="">Selecciona un producto</option>';
            productoSelect.disabled = true;

            if (selectedJuego) {
                productoSelect.disabled = false;
                let filteredProductos = productosDisponibles.filter(p => p.juego === selectedJuego);

                if (selectedColeccion) {
                    filteredProductos = filteredProductos.filter(p => p.coleccion === selectedColeccion);
                }

                if (filteredProductos.length === 0) {
                     productoSelect.innerHTML = '<option value="">No hay productos disponibles</option>';
                } else {
                     productoSelect.innerHTML = '<option value="">Selecciona un producto</option>';
                }

                filteredProductos.forEach(function(producto) {
                    const option = document.createElement('option');
                    option.value = producto.id;
                    option.dataset.precio = producto.precio; 
                    option.dataset.precioReserva = producto.precio_reserva; 
                    option.textContent = producto.nombre;
                    if (producto.id.toString() === selectedProductoId) {
                        option.selected = true;
                    }
                    productoSelect.appendChild(option);
                });
            } else {
                productoSelect.innerHTML = '<option value="">Primero selecciona un juego</option>';
            }
        }
        
        juegoSelect.addEventListener('change', function() {
            const selectedJuego = this.value;
            populateColecciones(selectedJuego, null);
            updateProductos(selectedJuego, "", null);
            calcularTotales(); 
        });

        coleccionSelect.addEventListener('change', function() {
            const selectedJuego = juegoSelect.value;
            const selectedColeccion = this.value;
            updateProductos(selectedJuego, selectedColeccion, null);
            calcularTotales();
        });

        tipoProductoSelect.addEventListener('change', function() {
            const selectedJuego = juegoSelect.value;
            const selectedColeccion = coleccionSelect.value;
            updateProductos(selectedJuego, selectedColeccion, initialProductoId);
            calcularTotales();
        });

        productoSelect.addEventListener('change', calcularTotales);
        cantidadInput.addEventListener('input', calcularTotales);
        pagadoInput.addEventListener('input', calcularTotales);

        function initialLoad() {
            if (initialJuego) {
                juegoSelect.value = initialJuego;
                populateColecciones(initialJuego, initialColeccion);
                updateProductos(initialJuego, initialColeccion, initialProductoId);
            }
            pagadoInput.value = initialPagado.toFixed(2);
            calcularTotales();
        }

        initialLoad();
    });
</script>
{% endblock %}
